#!/bin/bash
set -e

echo "=== Updating system and installing dependencies ==="
sudo apt update && sudo apt -y upgrade
sudo apt -y install unzip wget gnupg2 software-properties-common
sudo apt -y install openjdk-17-jdk
java -version

echo "=== Installing and configuring PostgreSQL ==="
sudo apt -y install postgresql postgresql-contrib
sudo systemctl enable --now postgresql

# Create SonarQube DB and user
sudo -u postgres psql -c "CREATE USER sonar WITH ENCRYPTED PASSWORD 'StrongPass#123';" || true
sudo -u postgres psql -c "CREATE DATABASE sonarqube OWNER sonar;" || true

echo "=== Waiting for PostgreSQL to be ready ==="
sleep 20

echo "=== Configuring system limits for SonarQube ==="
echo 'vm.max_map_count=524288' | sudo tee -a /etc/sysctl.conf
echo 'fs.file-max=131072' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

sudo tee -a /etc/security/limits.conf >/dev/null <<'EOF'
sonarqube   -   nofile   131072
sonarqube   -   nproc    8192
EOF

echo "=== Creating SonarQube user ==="
sudo useradd -r -s /bin/bash sonarqube || true

echo "=== Downloading and setting up SonarQube ==="
cd /opt
sudo wget -q https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-25.8.0.112029.zip
sudo unzip -q sonarqube-25.8.0.112029.zip
sudo mv sonarqube-25.8.0.112029 sonarqube
sudo chown -R sonarqube:sonarqube /opt/sonarqube

echo "=== Configuring SonarQube database connection ==="
sudo sed -i 's|#sonar.jdbc.username=.*|sonar.jdbc.username=sonar|' /opt/sonarqube/conf/sonar.properties
sudo sed -i 's|#sonar.jdbc.password=.*|sonar.jdbc.password=StrongPass#123|' /opt/sonarqube/conf/sonar.properties
sudo sed -i 's|#sonar.jdbc.url=jdbc:postgresql.*|sonar.jdbc.url=jdbc:postgresql://localhost:5432/sonarqube|' /opt/sonarqube/conf/sonar.properties

echo "=== Creating systemd service for SonarQube ==="
sudo tee /etc/systemd/system/sonarqube.service >/dev/null <<'EOF'
[Unit]
Description=SonarQube service
After=network.target postgresql.service

[Service]
Type=forking
User=sonarqube
Group=sonarqube
ExecStart=/opt/sonarqube/bin/linux-x86-64/sonar.sh start
ExecStop=/opt/sonarqube/bin/linux-x86-64/sonar.sh stop
LimitNOFILE=131072
LimitNPROC=8192
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

echo "=== Enabling and starting SonarQube service ==="
sudo systemctl daemon-reload
sudo systemctl enable sonarqube
sudo systemctl start sonarqube

echo "=== Checking SonarQube status ==="
sudo systemctl status sonarqube --no-pager
echo "=== SonarQube setup completed successfully! Access it via http://<server-ip>:9000 ==="